# dash.nyc — unified nginx config
# Generated by: make deploy-nginx

# ── subdomain → path redirects ──────────────────────────────────
# Subdomains redirect to dash.nyc/<app>/

map $host $app_path {
    art.dash.nyc       /art;
    drink.dash.nyc     /drink;
    eat.dash.nyc       /eat;
    food.dash.nyc      /food;
    make.dash.nyc      /make;
    movies.dash.nyc    /movies;
    music.dash.nyc     /music;
    pee.dash.nyc       /pee;
    play.dash.nyc      /play;
    relax.dash.nyc     /relax;
    shop.dash.nyc      /shop;
    theater.dash.nyc   /theater;
    today.dash.nyc     /today;
    vibe.dash.nyc      /vibe;
    weather.dash.nyc   /weather;
}

server {
    listen 80;
    server_name art.dash.nyc drink.dash.nyc eat.dash.nyc food.dash.nyc
                make.dash.nyc movies.dash.nyc music.dash.nyc
                pee.dash.nyc play.dash.nyc relax.dash.nyc shop.dash.nyc
                theater.dash.nyc today.dash.nyc vibe.dash.nyc weather.dash.nyc;
    return 301 https://dash.nyc$app_path$request_uri;
}
server {
    listen 443 ssl;
    server_name art.dash.nyc drink.dash.nyc eat.dash.nyc food.dash.nyc
                make.dash.nyc movies.dash.nyc music.dash.nyc
                pee.dash.nyc play.dash.nyc relax.dash.nyc shop.dash.nyc
                theater.dash.nyc today.dash.nyc vibe.dash.nyc weather.dash.nyc;

    ssl_certificate     {{CERT_PATH}}/fullchain.pem;
    ssl_certificate_key {{CERT_PATH}}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://dash.nyc$app_path$request_uri;
}

# ── production ──────────────────────────────────────────────────

server {
    listen 80;
    server_name dash.nyc;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl;
    server_name dash.nyc;

    ssl_certificate     {{CERT_PATH}}/fullchain.pem;
    ssl_certificate_key {{CERT_PATH}}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root {{PRODUCTION_PATH}}/dash.nyc;
    index index.html;

    location ~* \.(css|js|json|png|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public";
        gzip_static on;
    }

    location ~ /index\.html$ {
        add_header Cache-Control "no-cache";
    }

    location = /manifest.json {
        add_header Cache-Control "no-cache";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;

    access_log /var/log/nginx/dash.nyc.access.log;
    error_log  /var/log/nginx/dash.nyc.error.log;
}

# ── staging ─────────────────────────────────────────────────────

server {
    listen 80;
    server_name staging.dash.nyc;
    return 301 https://$host$request_uri;
}
server {
    listen 443 ssl;
    server_name staging.dash.nyc;

    ssl_certificate     {{CERT_PATH}}/fullchain.pem;
    ssl_certificate_key {{CERT_PATH}}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    root {{STAGING_PATH}}/dash.nyc;
    index index.html;

    location ~* \.(css|js|json|png|ico|svg|woff|woff2|ttf|eot)$ {
        expires 7d;
        add_header Cache-Control "public";
        gzip_static on;
    }

    location ~ /index\.html$ {
        add_header Cache-Control "no-cache";
    }

    location = /manifest.json {
        add_header Cache-Control "no-cache";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Robots-Tag "noindex, nofollow" always;

    access_log /var/log/nginx/staging.dash.nyc.access.log;
    error_log  /var/log/nginx/staging.dash.nyc.error.log;
}
